<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buddhi AI</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --bg2: #141414;
            --bg3: #1c1c1c;
            --bg4: #262626;
            --border: #2a2a2a;
            --text: #fafafa;
            --text2: #a3a3a3;
            --text3: #666;
            --accent: #3b82f6;
            --purple: #8b5cf6;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
        }

        /* Main Container */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Header */
        .header {
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg2);
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-sub {
            font-size: 10px;
            color: var(--text3);
            font-weight: 400;
            margin-left: 6px;
        }

        .new-btn {
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text2);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .new-btn:hover {
            background: var(--bg4);
            color: var(--text);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg2);
        }

        .messages {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Welcome Screen */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .welcome-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .welcome h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome p {
            color: var(--text3);
            font-size: 14px;
        }

        /* Messages */
        .msg {
            display: flex;
            gap: 14px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            color: white;
        }

        .avatar svg {
            width: 18px;
            height: 18px;
        }

        /* Animated User Avatar */
        @keyframes gradient-xy {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes float-icon {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-1px) scale(1.05);
            }
        }

        .msg.user .avatar {
            background: linear-gradient(-45deg, #6366f1, #a855f7, #ec4899, #3b82f6);
            background-size: 300% 300%;
            animation: gradient-xy 6s ease infinite;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .msg.user .avatar svg {
            animation: float-icon 3s ease-in-out infinite;
            width: 18px;
            height: 18px;
            color: rgba(255, 255, 255, 0.95);
        }

        /* Model-specific avatar colors */
        .avatar.groq {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .avatar.gemini {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .avatar.hf-mistral {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .avatar.hf-zephyr {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .avatar.hf-phi {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .avatar.fallback {
            background: linear-gradient(135deg, #64748b, #475569);
        }

        .msg-body {
            flex: 1;
            min-width: 0;
        }

        .msg-header {
            font-size: 11px;
            color: var(--text3);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .content {
            font-size: 15px;
            line-height: 1.65;
        }

        .content h1,
        .content h2,
        .content h3 {
            margin: 12px 0 8px;
            font-weight: 600;
            color: var(--text);
        }

        .content h1 {
            font-size: 1.4em;
        }

        .content h2 {
            font-size: 1.25em;
        }

        .content h3 {
            font-size: 1.1em;
        }

        .content ul,
        .content ol {
            margin: 8px 0 8px 24px;
        }

        .content li {
            margin-bottom: 4px;
        }

        .content p {
            margin-bottom: 10px;
        }

        .content p:last-child {
            margin-bottom: 0;
        }

        .content code {
            background: var(--bg4);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 13px;
        }

        .content pre {
            background: var(--bg3);
            padding: 14px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid var(--border);
        }

        .content pre code {
            background: none;
            padding: 0;
        }

        .content blockquote {
            border-left: 3px solid var(--border);
            padding-left: 12px;
            margin: 10px 0;
            color: var(--text3);
        }

        .content a {
            color: var(--accent);
            text-decoration: none;
        }

        .content a:hover {
            text-decoration: underline;
        }

        .content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .content th,
        .content td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
        }

        .content th {
            background: var(--bg3);
        }

        /* Copy Button */
        .msg-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            opacity: 1;
            /* Always visible */
        }

        .action-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text3);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .action-btn:hover {
            background: var(--bg3);
            color: var(--text);
            border-color: var(--border);
        }

        .action-btn svg {
            width: 12px;
            height: 12px;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: var(--accent);
            margin-left: 1px;
            animation: blink 0.6s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {

            0%,
            45% {
                opacity: 1;
            }

            55%,
            100% {
                opacity: 0;
            }
        }

        .thinking {
            color: var(--text3);
            font-size: 14px;
        }

        .error {
            color: #ef4444;
        }

        /* Input Area */
        .input-area {
            padding: 16px 24px 24px;
            background: var(--bg2);
            border-top: 1px solid var(--border);
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .input-box {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 14px;
            transition: all 0.15s;
        }

        .input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 140px;
            line-height: 1.5;
        }

        textarea::placeholder {
            color: var(--text3);
        }

        .input-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-select {
            background: var(--bg4);
            border: 1px solid var(--border);
            color: var(--text2);
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            min-width: 120px;
        }

        .model-select:hover {
            border-color: var(--text3);
        }

        .model-select option {
            background: var(--bg3);
        }

        .send-btn {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent), #2563eb);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .send-btn:hover {
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Memory Panel */
        .memory-panel {
            width: 280px;
            background: var(--bg2);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .memory-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text2);
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .memory-header svg {
            width: 14px;
            height: 14px;
            color: var(--purple);
        }

        .memory-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.5;
        }

        .memory-empty {
            color: var(--text3);
            text-align: center;
            padding: 30px 16px;
            font-style: italic;
        }

        .memory-item {
            padding: 10px 12px;
            background: var(--bg3);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--purple);
        }

        .memory-item .turn {
            font-size: 9px;
            color: var(--purple);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .memory-item .q {
            color: var(--text);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .memory-item .a {
            color: var(--text3);
            font-size: 10px;
        }

        .memory-footer {
            padding: 12px;
            font-size: 9px;
            text-align: center;
            border-top: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.03), rgba(59, 130, 246, 0.03));
        }

        .memory-footer a {
            color: var(--text3);
            text-decoration: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .memory-footer a:hover {
            color: var(--purple);
            text-shadow: 0 0 8px rgba(139, 92, 246, 0.5);
        }

        .memory-footer .heart {
            color: #ef4444;
            font-size: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .memory-panel {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .header {
                padding: 12px 16px;
            }

            .chat-area {
                padding: 16px;
            }

            .input-area {
                padding: 12px 16px 20px;
            }
        }
    </style>
</head>

<body>
    <div class="main">
        <header class="header">
            <span class="logo">‡∞¨‡±Å‡∞¶‡±ç‡∞ß‡∞ø<span class="logo-sub">Buddhi</span></span>
            <button class="new-btn" id="newBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                New Chat
            </button>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="welcome" id="welcome">
                <div class="welcome-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                </div>
                <h1>How can I help?</h1>
                <p>Ask anything. I remember our conversation.</p>
            </div>
            <div class="messages" id="messages" style="display: none;"></div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <div class="input-box">
                    <div class="input-row">
                        <textarea id="input" placeholder="Ask anything..." rows="1"></textarea>
                        <div class="input-controls">
                            <select class="model-select" id="modelSelect">
                                <option>Loading...</option>
                            </select>
                            <button class="send-btn" id="sendBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside class="memory-panel">
        <div class="memory-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 6v6l4 2" />
            </svg>
            Context Memory
        </div>
        <div class="memory-content" id="memoryPanel">
            <div class="memory-empty">Memory updates as you chat...</div>
        </div>
        <div class="memory-footer">
            <a href="#">lost in a murky space</a>
        </div>
    </aside>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // =============================================================================
        // State
        // =============================================================================

        let memory = { entries: [] };
        let chatHistory = []; // Stores {role, text, model}
        let isSending = false;

        // =============================================================================
        // DOM Elements
        // =============================================================================

        const $ = id => document.getElementById(id);
        const chatArea = $('chatArea');
        const messages = $('messages');
        const welcome = $('welcome');
        const input = $('input');
        const modelSelect = $('modelSelect');
        const sendBtn = $('sendBtn');
        const memoryPanel = $('memoryPanel');

        // =============================================================================
        // Model Icons & Names
        // =============================================================================

        const MODEL_ICONS = {
            'groq': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
            'gemini': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M3 12h18M5.6 5.6l12.8 12.8M18.4 5.6L5.6 18.4"/></svg>',
            'hf-mistral': '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>',
            'hf-zephyr': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>',
            'hf-phi': '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="#000"/></svg>',
            'fallback': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>'
        };

        const MODEL_NAMES = {
            'groq': 'Groq',
            'gemini': 'Gemini',
            'hf-mistral': 'Mistral',
            'hf-zephyr': 'Zephyr',
            'hf-phi': 'Phi-3'
        };

        const MODEL_EMOJIS = {
            'groq': '‚ö°',
            'gemini': '‚ú®',
            'hf-mistral': 'üåü',
            'hf-zephyr': 'üí®',
            'hf-phi': 'üîÆ'
        };

        // =============================================================================
        // Initialization
        // =============================================================================

        async function init() {
            // Configure marked
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            // Restore state from localStorage
            loadState();

            try {
                const response = await fetch('/api/models');
                const data = await response.json();

                // Group by provider
                const byProvider = {};
                data.models.forEach(model => {
                    if (!byProvider[model.provider]) {
                        byProvider[model.provider] = [];
                    }
                    byProvider[model.provider].push(model);
                });

                // Build dropdown
                modelSelect.innerHTML = Object.entries(byProvider).map(([provider, models]) => {
                    const options = models.map(m => {
                        const emoji = MODEL_EMOJIS[m.id] || 'ü§ñ';
                        const disabled = !m.available ? ' disabled' : '';
                        const suffix = !m.available ? ' ‚ùå' : '';
                        return `<option value="${m.id}"${disabled}>${emoji} ${m.name}${suffix}</option>`;
                    }).join('');
                    return `<optgroup label="${provider}">${options}</optgroup>`;
                }).join('');

                // Select first available
                const firstAvailable = data.models.find(m => m.available);
                if (firstAvailable) {
                    modelSelect.value = firstAvailable.id;
                }
            } catch (error) {
                console.error('Failed to load models:', error);
            }

            // Event listeners
            input.addEventListener('input', autoResize);
            input.addEventListener('keydown', handleKeydown);
            sendBtn.addEventListener('click', sendMessage);
            $('newBtn').addEventListener('click', newChat);
        }

        function loadState() {
            try {
                const savedMemory = localStorage.getItem('chat_memory');
                if (savedMemory) {
                    memory = JSON.parse(savedMemory);
                    updateMemoryPanel();
                }

                const savedHistory = localStorage.getItem('chat_history');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    if (chatHistory.length > 0) {
                        welcome.style.display = 'none';
                        messages.style.display = 'flex';
                        chatHistory.forEach(msg => {
                            addMessage(msg.role, msg.text, false, msg.model);
                        });
                        scrollToBottom();
                    }
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }

        function saveState() {
            try {
                localStorage.setItem('chat_memory', JSON.stringify(memory));
                localStorage.setItem('chat_history', JSON.stringify(chatHistory));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        function autoResize() {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 140) + 'px';
        }

        function handleKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // =============================================================================
        // Chat Functions
        // =============================================================================

        function newChat() {
            if (confirm('Start a new chat? This will clear current conversation.')) {
                memory = { entries: [] };
                chatHistory = [];
                localStorage.removeItem('chat_memory');
                localStorage.removeItem('chat_history');

                messages.innerHTML = '';
                messages.style.display = 'none';
                welcome.style.display = 'flex';
                updateMemoryPanel();
                input.value = '';
                autoResize();
            }
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text || isSending) return;

            isSending = true;
            sendBtn.disabled = true;

            // Show messages area
            welcome.style.display = 'none';
            messages.style.display = 'flex';

            // Add user message
            addMessage('user', text);
            // Save user message to history
            chatHistory.push({ role: 'user', text: text });
            saveState();

            input.value = '';
            autoResize();

            // Add AI message placeholder
            const selectedModel = modelSelect.value;
            const aiMessageDiv = addMessage('ai', '', true, selectedModel);
            const contentEl = aiMessageDiv.querySelector('.content');

            // Placeholder for AI message in history (will update later)
            const historyIndex = chatHistory.length;
            chatHistory.push({ role: 'ai', text: '', model: selectedModel });

            try {
                const response = await fetch('/api/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: text,
                        model: selectedModel,
                        temp: 0.7,
                        memory: JSON.stringify(memory)
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let fullResponse = '';
                let buffer = '';
                let currentEvent = 'message';

                contentEl.innerHTML = '<span class="cursor"></span>';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process complete lines
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (currentEvent === 'memory') {
                                try {
                                    memory = JSON.parse(data);
                                    updateMemoryPanel();
                                    saveState(); // Save memory update
                                } catch (e) {
                                    console.error('Memory parse error:', e);
                                }
                            } else {
                                try {
                                    const chunk = JSON.parse(data);
                                    if (chunk !== '[DONE]') {
                                        fullResponse += chunk;
                                        contentEl.innerHTML = formatText(fullResponse) + '<span class="cursor"></span>';
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    if (data !== '"[DONE]"') {
                                        fullResponse += data;
                                        contentEl.innerHTML = formatText(fullResponse) + '<span class="cursor"></span>';
                                        scrollToBottom();
                                    }
                                }
                            }
                            currentEvent = 'message';
                        }
                    }
                }

                // Finalize
                contentEl.innerHTML = formatText(fullResponse);

                // Update history with full response
                chatHistory[historyIndex].text = fullResponse;

                // Handle fallback
                if (fullResponse.startsWith('[Fallback:')) {
                    const match = fullResponse.match(/\[Fallback: ([^\]]+)\]/);
                    if (match) {
                        const fallbackModel = match[1];
                        const header = aiMessageDiv.querySelector('.msg-header');
                        const avatar = aiMessageDiv.querySelector('.avatar');

                        header.textContent = `${MODEL_NAMES[fallbackModel] || fallbackModel} (fallback)`;
                        avatar.className = 'avatar fallback';
                        avatar.innerHTML = MODEL_ICONS[fallbackModel] || MODEL_ICONS['fallback']; // Fix: logic error in my head previously, assume MODEL_ICONS has keys

                        // Update model in history
                        chatHistory[historyIndex].model = fallbackModel;
                        chatHistory[historyIndex].text = fullResponse.replace(/\[Fallback: [^\]]+\] /, '');
                        contentEl.innerHTML = formatText(chatHistory[historyIndex].text);
                    }
                }

                saveState(); // Save final state

            } catch (error) {
                contentEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                chatHistory[historyIndex].text = `Error: ${error.message}`;
                saveState();
            }

            isSending = false;
            sendBtn.disabled = false;
            scrollToBottom();
        }

        // =============================================================================
        // UI Helpers
        // =============================================================================

        function addMessage(role, text, isLoading = false, modelId = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;

            let avatarContent, headerText, avatarClass;

            if (role === 'user') {
                avatarContent = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>`;
                headerText = 'You';
                avatarClass = '';
            } else {
                const model = modelId || modelSelect.value;
                avatarContent = MODEL_ICONS[model] || MODEL_ICONS['groq'];
                headerText = MODEL_NAMES[model] || model;
                avatarClass = model;
            }

            div.innerHTML = `
                <div class="avatar ${avatarClass}">${avatarContent}</div>
                <div class="msg-body">
                    <div class="msg-header">${headerText}</div>
                    <div class="content">${isLoading ? '<span class="thinking">Thinking...</span>' : formatText(text)}</div>
                    ${role === 'user' ? '' : `
                    <div class="msg-actions">
                        <button class="action-btn" onclick="copyText(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy
                        </button>
                    </div>`}
                </div>
            `;

            messages.appendChild(div);
            scrollToBottom();
            return div;
        }

        function updateMemoryPanel() {
            if (!memory.entries || memory.entries.length === 0) {
                memoryPanel.innerHTML = '<div class="memory-empty">Memory updates as you chat...</div>';
                return;
            }

            // Show newest first
            const items = [...memory.entries].reverse();
            memoryPanel.innerHTML = items.map((entry, idx) => `
                <div class="memory-item">
                    <div class="q"><strong>User:</strong> ${escapeHtml(entry.q)}</div>
                    <div class="a"><strong>Assistant:</strong> ${escapeHtml(entry.a)}</div>
                </div>
            `).join('');
        }

        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function formatText(text) {
            if (!text) return '';
            try {
                // Use marked.js if available
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
            } catch (e) {
                console.error('Marked parse error:', e);
            }

            // Fallback simple formatting
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .split('\n\n')
                .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
                .join('');
        }

        function copyText(btn) {
            const msgBody = btn.closest('.msg-body');
            // Try to get raw text if possible, but innerText is okay for now
            const content = msgBody.querySelector('.content').innerText;

            navigator.clipboard.writeText(content).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--success)">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Copied
                `;
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        }

        function escapeHtml(str) {
            if (!str) return '';
            const escapeMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return str.replace(/[&<>"']/g, char => escapeMap[char]);
        }

        // Start the app
        init();
    </script>
</body>

</html>